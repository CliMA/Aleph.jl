env:
  JULIA_VERSION: "1.8.5"
  MPI_IMPL: "openmpi"
  OPENMPI_VERSION: "4.1.1"
  CUDA_VERSION: "11.2"
  OPENBLAS_NUM_THREADS: 1
  CLIMATEMACHINE_SETTINGS_FIX_RNG_SEED: "true"
  BUILDKITE_COMMIT: "${BUILDKITE_COMMIT}"
  BUILDKITE_BRANCH: "${BUILDKITE_BRANCH}"
  JULIA_MAX_NUM_PRECOMPILE_FILES: 100
  JULIA_DEPOT_PATH: "${BUILDKITE_BUILD_PATH}/${BUILDKITE_PIPELINE_SLUG}/depot/cpu"

agents:
  config: cpu
  queue: central

steps:
  - label: "init :computer:"
    key: "init_cpu_env"
    command:
      - "echo $$JULIA_DEPOT_PATH"

      - echo "--- Configure MPI"
      - julia -e 'using Pkg; Pkg.add("MPIPreferences"); using MPIPreferences; use_system_binary()'

      - echo "--- Instantiate project"
      - "julia --project -e 'using Pkg; Pkg.instantiate(;verbose=true)'"
      - "julia --project -e 'using Pkg; Pkg.precompile()'"
      - "julia --project -e 'using Pkg; Pkg.status()'"

      - echo "--- Instantiate test"
      - "julia --project=test -e 'using Pkg; Pkg.develop(path = \".\")'"
      - "julia --project=test -e 'using Pkg; Pkg.instantiate(;verbose=true)'"
      - "julia --project=test -e 'using Pkg; Pkg.precompile()'"
      - "julia --project=test -e 'using Pkg; Pkg.status()'"

      - echo "--- Instantiate examples"
      - "julia --project=examples -e 'using Pkg; Pkg.instantiate(;verbose=true)'"
      - "julia --project=examples -e 'using Pkg; Pkg.precompile()'"
      - "julia --project=examples -e 'using Pkg; Pkg.status()'"

      - echo "--- Instantiate ode compat examples"
      - "julia --project=ode_compat_examples -e 'using Pkg; Pkg.instantiate(;verbose=true)'"
      - "julia --project=ode_compat_examples -e 'using Pkg; Pkg.precompile()'"
      - "julia --project=ode_compat_examples -e 'using Pkg; Pkg.status()'"

      - echo "--- Instantiate perf"
      - "julia --project=perf -e 'using Pkg; Pkg.instantiate(;verbose=true)'"
      - "julia --project=perf -e 'using Pkg; Pkg.precompile()'"
      - "julia --project=perf -e 'using Pkg; Pkg.status()'"

      - echo "--- Download artifacts"
      - "julia --project=examples artifacts/download_artifacts.jl"

    agents:
      slurm_cpus_per_task: 8
    env:
      JULIA_NUM_PRECOMPILE_TASKS: 8
      JULIA_MAX_NUM_PRECOMPILE_FILES: 50

  - wait

  - group: "Regression tests"
    steps:

      - label: ":computer: Ensure mse tables are reset when necessary"
        command: "julia --color=yes --project=examples regression_tests/test_reset.jl"

  - group: "TurbulenceConvection"
    steps:

      - label: ":balloon: SCM EDMF: Nieuwstadt (Dry)"
        command: >
          julia --color=yes --project=examples examples/hybrid/driver.jl
          --config column --turbconv edmf --debugging_tc true --regression_test true
          --FLOAT_TYPE Float64 --hyperdiff false --apply_limiter false
          --turbconv_case Nieuwstadt
          --z_elem 200 --z_stretch false --z_max 3750
          --t_end 8hours --dt_save_to_sol 5mins --dt_save_to_disk 5mins
          --moist dry
          --job_id edmf_nieuwstadt
          --dt 0.5secs

          julia --color=yes --project=examples regression_tests/test_mse.jl --job_id edmf_nieuwstadt --out_dir edmf_nieuwstadt
        artifact_paths: "edmf_nieuwstadt/*"
        agents:
          slurm_mem: 20GB

      - label: ":balloon: SCM EDMF Soares"
        command: >
          julia --color=yes --project=examples examples/hybrid/driver.jl
          --config column --turbconv edmf --debugging_tc true --regression_test true
          --FLOAT_TYPE Float64 --hyperdiff false --apply_limiter false
          --turbconv_case Soares
          --z_elem 150 --z_stretch false --z_max 3750
          --t_end 8hours --dt_save_to_sol 5mins --dt_save_to_disk 5mins
          --moist equil
          --job_id edmf_soares
          --dt 0.25secs

          julia --color=yes --project=examples regression_tests/test_mse.jl --job_id edmf_soares --out_dir edmf_soares
        artifact_paths: "edmf_soares/*"
        agents:
          slurm_mem: 20GB

      - label: ":balloon: SCM EDMF Bomex (Default: Newton's method)"
        command: >
          julia --color=yes --project=examples examples/hybrid/driver.jl
          --config column --turbconv edmf --debugging_tc true
          --FLOAT_TYPE Float64 --hyperdiff false --apply_limiter false
          --turbconv_case Bomex --subsidence Bomex --edmf_coriolis Bomex --ls_adv Bomex
          --z_elem 60 --z_stretch false --z_max 3e3
          --t_end 6hours --dt_save_to_sol 5mins --dt_save_to_disk 5mins
          --moist equil
          --job_id edmf_bomex
          --dt 5secs
        artifact_paths: "edmf_bomex/*"
        agents:
          slurm_mem: 20GB

      - label: ":balloon: SCM EDMF Bomex (JFNK)"
        command: >
          julia --color=yes --project=examples examples/hybrid/driver.jl
          --config column --turbconv edmf --debugging_tc true
          --FLOAT_TYPE Float64 --hyperdiff false --apply_limiter false
          --turbconv_case Bomex --subsidence Bomex --edmf_coriolis Bomex --ls_adv Bomex
          --z_elem 60 --z_stretch false --z_max 3e3
          --t_end 6hours --dt_save_to_sol 5mins --dt_save_to_disk 5mins
          --moist equil
          --use_krylov_method true
          --job_id edmf_bomex_jfnk
          --dt 15secs

          julia --color=yes --project=examples regression_tests/test_mse.jl --job_id edmf_bomex_jfnk --out_dir edmf_bomex_jfnk
        artifact_paths: "edmf_bomex_jfnk/*"
        agents:
          slurm_mem: 20GB

      - label: ":balloon: SCM EDMF DYCOMS_RF01"
        command: >
          julia --color=yes --project=examples examples/hybrid/driver.jl
          --config column --turbconv edmf --debugging_tc true
          --FLOAT_TYPE Float64 --hyperdiff false --apply_limiter false
          --turbconv_case DYCOMS_RF01 --subsidence DYCOMS --edmf_coriolis DYCOMS_RF01 --rad DYCOMS_RF01
          --z_elem 30 --z_stretch false --z_max 1500
          --t_end 4hours --dt_save_to_sol 5mins --dt_save_to_disk 2mins
          --moist equil
          --job_id edmf_dycoms_rf01
          --dt 6secs

          julia --color=yes --project=examples regression_tests/test_mse.jl --job_id edmf_dycoms_rf01 --out_dir edmf_dycoms_rf01
        artifact_paths: "edmf_dycoms_rf01/*"
        agents:
          slurm_mem: 20GB

      - label: ":balloon: SCM EDMF LifeCycleTan2018"
        command: >
          julia --color=yes --project=examples examples/hybrid/driver.jl
          --config column --turbconv edmf --debugging_tc true
          --FLOAT_TYPE Float64 --hyperdiff false --apply_limiter false
          --turbconv_case LifeCycleTan2018 --subsidence LifeCycleTan2018 --edmf_coriolis LifeCycleTan2018 --ls_adv LifeCycleTan2018
          --z_elem 75 --z_stretch false --z_max 3e3
          --t_end 6hours --dt_save_to_sol 5mins --dt_save_to_disk 5mins
          --moist equil
          --job_id edmf_life_cycle_tan2018
          --dt 6secs

          julia --color=yes --project=examples regression_tests/test_mse.jl --job_id edmf_life_cycle_tan2018 --out_dir edmf_life_cycle_tan2018
        artifact_paths: "edmf_life_cycle_tan2018/*"
        agents:
          slurm_mem: 20GB

      - label: ":balloon: SCM EDMF Rico"
        command: >
          julia --color=yes --project=examples examples/hybrid/driver.jl
          --config column --turbconv edmf --debugging_tc true
          --FLOAT_TYPE Float64 --hyperdiff false --apply_limiter false
          --turbconv_case Rico --ls_adv Rico --subsidence Rico
          --z_elem 100 --z_stretch false --z_max 4000
          --t_end 24hours --dt_save_to_sol 5mins --dt_save_to_disk 8mins
          --moist equil --precip_model 1M
          --job_id edmf_rico
          --dt 0.75secs

          julia --color=yes --project=examples regression_tests/test_mse.jl --job_id edmf_rico --out_dir edmf_rico
        artifact_paths: "edmf_rico/*"
        agents:
          slurm_mem: 20GB

      - label: ":balloon: SCM EDMF TRMM_LBA (Short, 1-moment micro, sponge)"
        command: >
          julia --color=yes --project=examples examples/hybrid/driver.jl
          --config column --turbconv edmf --debugging_tc true
          --FLOAT_TYPE Float64 --hyperdiff false --apply_limiter false
          --turbconv_case TRMM_LBA --rad TRMM_LBA
          --z_elem 82 --z_stretch false --z_max 16400
          --rayleigh_sponge true --zd_rayleigh 15000
          --t_end 1hours --dt_save_to_sol 5mins --dt_save_to_disk 1mins
          --moist equil --precip_model 1M
          --job_id edmf_trmm
          --dt 0.02secs
        artifact_paths: "edmf_trmm/*"
        agents:
          slurm_mem: 20GB

  - wait: ~
    continue_on_failure: true

  - label: ":robot_face: Print new mse tables"
    command: "julia --color=yes --project=examples regression_tests/print_new_mse.jl"

  - label: ":robot_face: Print new reference counter"
    command: "julia --color=yes --project=examples regression_tests/print_new_ref_counter.jl"

  - label: ":bar_chart: Tabulate performance summary"
    command: "julia --color=yes --project=perf perf/tabulate_perf_summary.jl"

  - label: ":chart_with_downwards_trend: build history"
    command:
      - build_history main
    artifact_paths:
      - "build_history.html"

  - wait

  - label: ":robot_face: Move main results"
    command: "julia --color=yes --project=examples regression_tests/move_output.jl"
